<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro-Network Visualizer</title>
    <style>
        :root { --accent-color: #007bff; --bg-color: #f8f9fa; --card-bg: #ffffff; --text-color: #333; --border-color: #dee2e6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 2rem; }
        header { text-align: center; margin-bottom: 2rem; }
        .container { max-width: 900px; margin: auto; }
        .controls { background: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .form-group { display: flex; gap: 1rem; }
        input[type="text"] { flex-grow: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        button { font-size: 1rem; padding: 0.75rem 1.5rem; border-radius: 4px; border: none; cursor: pointer; background-color: var(--accent-color); color: white; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        .node-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .node-card { background: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .node-card h3 { margin: 0 0 0.5rem; }
        .node-card p { margin: 0.2rem 0; font-size: 0.9rem; color: #6c757d; }
        .node-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .node-actions button { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-update { background-color: #ffc107; color: #212529; }
        .btn-update:hover { background-color: #e0a800; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Micro-Network Visualizer</h1>
        </header>

        <section class="controls">
            <h2>Add New Node</h2>
            <div class="form-group">
                <input type="text" id="node-name-input" placeholder="Enter node name (e.g., 'auth-service')">
                <button id="add-node-btn">Add Service</button>
            </div>
        </section>

        <main>
            <h2>Live Nodes</h2>
            <div id="node-list-container" class="node-list">
                <!-- Nodes will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <script>
        const nodeListContainer = document.getElementById('node-list-container');
        const addNodeBtn = document.getElementById('add-node-btn');
        const nodeNameInput = document.getElementById('node-name-input');

        // --- API Functions ---

        const getNodes = async () => {
            try {
                // In the real deployment, the browser calls the EC2 instance's public IP,
                // which reverse-proxies to the frontend service. The frontend service then calls the
                // backend service internally. For local testing, we'd need to adjust this URL.
                // For now, we'll assume the frontend server will proxy requests.
                // A better approach is relative URLs if the frontend server proxies.
                const response = await fetch(`/api/nodes`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("Failed to fetch nodes:", error);
                nodeListContainer.innerHTML = '<p>Error: Could not load nodes from the API.</p>';
                return [];
            }
        };

        const addNode = async (name) => {
            await fetch(`/api/nodes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            await renderNodes();
        };

        const deleteNode = async (id) => {
            await fetch(`/api/nodes/${id}`, { method: 'DELETE' });
            await renderNodes();
        };
        
        const updateNode = async (id, newName) => {
            await fetch(`/api/nodes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });
            await renderNodes();
        };


        // --- UI Rendering ---

        const renderNodes = async () => {
            nodeListContainer.innerHTML = '<p>Loading nodes...</p>';
            const nodes = await getNodes();
            nodeListContainer.innerHTML = ''; // Clear loading message
            if (nodes.length === 0) {
                nodeListContainer.innerHTML = '<p>No live nodes found.</p>';
                return;
            }
            nodes.forEach(node => {
                const card = document.createElement('div');
                card.className = 'node-card';
                card.innerHTML = `
                    <h3>${node.name}</h3>
                    <p><strong>ID:</strong> ${node.id.substring(0, 8)}</p>
                    <p><strong>Type:</strong> ${node.type}</p>
                    <p><strong>Status:</strong> ${node.status}</p>
                    <div class="node-actions">
                        <button class="btn-update" data-id="${node.id}" data-name="${node.name}">Update</button>
                        <button class="btn-delete" data-id="${node.id}">Delete</button>
                    </div>
                `;
                nodeListContainer.appendChild(card);
            });
        };

        // --- Event Listeners ---

        addNodeBtn.addEventListener('click', () => {
            const name = nodeNameInput.value.trim();
            if (name) {
                addNode(name);
                nodeNameInput.value = '';
            } else {
                alert('Please enter a node name.');
            }
        });

        nodeListContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-delete')) {
                const id = e.target.dataset.id;
                if (confirm('Are you sure you want to delete this node?')) {
                    deleteNode(id);
                }
            }
            if (e.target.classList.contains('btn-update')) {
                const id = e.target.dataset.id;
                const currentName = e.target.dataset.name;
                const newName = prompt('Enter the new name for the node:', currentName);
                if (newName && newName.trim() !== currentName) {
                    updateNode(id, newName.trim());
                }
            }
        });

        // Initial render
        document.addEventListener('DOMContentLoaded', renderNodes);
    </script>
</body>
</html>
