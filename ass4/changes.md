# Assignment 4: Changes & Justifications

This document details the key changes made during the implementation of Assignment 4. This assignment marked a major architectural evolution, splitting into two distinct paths:
1.  **Part A:** Enhancing the original flat network with a service registry and security policies.
2.  **Part B:** Building a completely new, advanced architecture with network segmentation and load balancing.

---

## Part A: Changes to the Flat Network

### Summary of Key Changes (Service Registry & Security)

| Feature                 | Original Plan                                                                          | Actual Implementation (`assignment4.sh`)                                                                                                                                                             | Justification & Error Avoided                                                                                                                                                                                                                                   |
| ----------------------- | -------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Tooling**             | Separate, manual scripts for service registry and security.                            | A single, unified toolkit (`assignment4.sh`) with clear subcommands (`start-registry`, `apply-policies`, etc.).                                                                                          | **Justification:** This provides a much cleaner, more manageable, and professional interface for advanced network functions, centralizing control in one place.                                                                                                    |
| **Security Policy**     | A list of `ACCEPT` rules without a default `DROP`.                                     | A more secure implementation that first sets the default `FORWARD` policy to `DROP` and explicitly allows `ESTABLISHED,RELATED` traffic.                                                              | **Error Avoided:** The original plan was insecure. It would have allowed any traffic not explicitly matching a rule, defeating the purpose of a firewall. The implemented "default deny" strategy is a fundamental security best practice. The lack of a `conntrack` rule for established connections would have broken all two-way communication (like HTTP responses). |
| **Dependency Management** | Manual installation of `Flask` was assumed.                                            | The script integrates with the shared Python virtual environment created in Assignment 2, ensuring dependencies are managed correctly and automatically.                                                  | **Justification:** This avoids polluting the global Python environment and ensures that the correct library versions are used, making the setup more robust and reproducible.                                                                               |

---

## Part B: The New Segmented & Load-Balanced Architecture

The most significant change was the introduction of a new, advanced architecture in the `modified_setup/` directory. This was a deliberate move away from patching the simple flat network to building a more realistic, secure, and scalable system from the ground up.

### Justification for the New Architecture

The original flat network had significant limitations that would be difficult to overcome. The decision to build a new, segmented architecture was driven by the need to implement professional-grade features correctly.

| Feature                   | Original Flat Network Limitation                                                                    | New Segmented Architecture Solution                                                                                                     | Justification & Benefit                                                                                                                                                                                          |
| ------------------------- | --------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Security & Isolation**  | All services were on the same bridge (`br0`), meaning a compromise of one service could easily spread to others. Security was entirely dependent on complex `iptables` rules. | **Network Segmentation**. Three separate bridges (`br-frontend`, `br-backend`, `br-database`) isolate the application tiers. The database is on a completely separate network from the frontend. | **Benefit:** This is "defense in depth." An attacker who compromises the web-facing Nginx container cannot directly attack the PostgreSQL database because they are not on the same network. Security is enforced by the topology itself, which is far more robust. |
| **Scalability**           | Ran only a single instance of each service. Scaling would require complex manual work.                | **Native Load Balancing**. The architecture was designed to run multiple replicas of the `product-service` from the start, with a new `api-gateway-lb.py` that automatically distributes traffic among them. | **Benefit:** This is the foundation of a scalable system. It allows the application to handle increased traffic by simply adding more service replicas, a core concept of microservices.                                      |
| **Automation**            | The original plan implied manual, error-prone changes to the network to add new bridges and services. | **Fully Automated Deployment**. The new `assignment4-network.sh` and `assignment4-services.sh` scripts can create and destroy the entire advanced environment with just two commands. | **Benefit:** This infrastructure-as-code approach is essential for modern operations. It guarantees a consistent, repeatable, and reliable deployment, which would be nearly impossible to achieve manually with this level of complexity. |
| **Organization**          | All services were mixed together in a single IP range.                                                | **Tiered Architecture**. Services are organized into logical tiers (frontend, backend, data) with their own subnets. This is a standard and well-understood pattern. | **Benefit:** This improves maintainability and makes the system easier to reason about. It also contains the "blast radius" of failures; a problem in one tier is less likely to cascade and affect another.       |

### Post-Implementation Fixes and Documentation

After the initial implementation of the segmented architecture, a critical bug was discovered where the services would not start, even though the scripts were syntactically correct.

| Issue Discovered | Root Cause | Solution | Justification & Lesson Learned |
| :--- | :--- | :--- | :--- |
| **Services Not Starting** | The `assignment4-network.sh` script was not installing `redis-server` and `nginx` as prerequisites. The `assignment4-services.sh` script would then fail when trying to start these services, and because of `set -e`, it would exit before creating any log files, making the issue difficult to diagnose. | The `apt-get install` command in `assignment4-network.sh` was updated to include `redis-server` and `nginx`. | **Lesson Learned:** Always check the prerequisites. The lack of log files was the key clue that the script was failing early. The first step in debugging should be to verify that all dependencies are present. |
| **Verifying Load Balancing** | The `README.md` file did not contain instructions on how to verify that the round-robin load balancing was working. | A new section was added to `ass4/modified_setup/README.md` explaining how to use a `for` loop with `curl` to send multiple requests to the `/api/products` endpoint and how to use `tail -f` on the log files of the product service replicas to observe the round-robin distribution of requests. | **Justification:** Good documentation is as important as working code. This new section provides clear and easy-to-follow instructions for verifying a key feature of the new architecture. |

